name: Deploy Backend App

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 1. 자바(JDK) 세팅
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: "gradle"

      # 2. Gradle 빌드
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew bootJar -x test

      - name: Verify Build Jar
        run: |
          if ls build/libs/*.jar 1> /dev/null 2>&1; then
            echo "Build Success: JAR file found."
          else
            echo "Build Failed: No JAR file found in build/libs/"
            exit 1
          fi
          echo "빌드파일 만들기 성공"

      # 점검 모드 활성화 (기존 화면 백업 -> 점검 페이지 적용)
      - name: Enable Maintenance Mode
        if: github.event_name == 'push'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # 1. 현재 서비스 중인 index.html을 임시 파일로 백업 (_tmp)
            cp /home/ubuntu/deploy/front/dist/index.html /home/ubuntu/deploy/maintenance/index_tmp.html
            
            # 2. 준비된 점검 페이지(index.html)를 서비스 경로로 덮어쓰기
            # (주의: 서버 maintenance 폴더 안에 파일명이 index.html 인지 꼭 확인하세요)
            cp /home/ubuntu/deploy/maintenance/index.html /home/ubuntu/deploy/front/dist/index.html
            
            echo "점검 모드 페이지 적용 완료"

      # 3. 서버 준비
      - name: Prepare Target Directory
        if: github.event_name == 'push'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            mkdir -p /home/ubuntu/deploy/back/backup
            sudo chown -R ubuntu:ubuntu /home/ubuntu/deploy/back
            find /home/ubuntu/deploy/back/backup -name "backup-*.jar" -mtime +3 -delete
            
            # 기존 test.jar가 있으면 백업
            if ls /home/ubuntu/deploy/back/test.jar 1> /dev/null 2>&1; then
              mv /home/ubuntu/deploy/back/test.jar /home/ubuntu/deploy/back/backup/backup-$(date +%Y%m%d%H%M%S).jar
            fi

      # 4. 새 Jar 파일 서버로 전송
      - name: Deploy Backend JAR To EC2
        if: github.event_name == 'push'
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          source: "build/libs/*.jar"
          target: "/home/ubuntu/deploy/back"
          strip_components: 2
          overwrite: true

      # 5. 재시작 및 점검 모드 해제
      - name: Restart Container & Disable Maintenance
        if: github.event_name == 'push'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Jar 파일이 있는 폴더로 먼저 이동해야 함!
            cd /home/ubuntu/deploy/back
            
            # 파일 이름을 test.jar로 변경 (docker-compose 설정 맞춤)
            mv *.jar server.jar
            
            # 다시 홈으로 나와서 컨테이너 재시작
            cd /home/ubuntu/deploy
            docker compose restart api
            docker image prune -f
            
            # 서버가 켜질 때까지 대기 (50초)
            echo "서버 부팅 대기 중..."
            sleep 50
            
            # 점검 모드 해제 (백업해둔 원본 파일을 다시 원위치로 이동)
            mv /home/ubuntu/deploy/maintenance/index_tmp.html /home/ubuntu/deploy/front/dist/index.html
            
            echo "배포 완료 및 정상 화면 복구됨"