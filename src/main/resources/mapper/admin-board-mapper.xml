<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.eco.admin.model.dao.AdminBoardMapper">
	
	<sql id="findAdminBoardDTO">
		SELECT
               B.BOARD_NO boardNo
             , B.BOARD_TITLE boardTitle
             , B.REG_DATE regDate
             , B.BOARD_CONTENT boardContent
             , B.STATUS status
             , COUNT(CASE WHEN BR.STATUS = 'Y' THEN 1 END) AS boardReportCount
             , M.MEMBER_ID memberId
          FROM 
               TB_BOARD B
          JOIN 
               TB_MEMBER M ON B.REF_MNO = M.MEMBER_NO
          LEFT 
          JOIN 
               TB_BOARD_REPORT BR ON BR.REF_BNO = B.BOARD_NO
	</sql>
	
	<sql id="groupByAdminBoardDTO">
         GROUP 
            BY
               B.BOARD_NO
             , B.BOARD_TITLE
             , B.BOARD_CONTENT
             , B.REG_DATE
             , B.STATUS
             , M.MEMBER_ID		
	</sql>
	
	<select id="findBoardAll" resultType="AdminBoardDTO">
		<include refid="findAdminBoardDTO" />
		<include refid="groupByAdminBoardDTO" />
         ORDER
            BY 
               B.BOARD_NO DESC
	</select>
	
	<select id="findReportedBoard" resultType="AdminBoardDTO">
		<include refid="findAdminBoardDTO" />
		<include refid="groupByAdminBoardDTO" />
		HAVING
       		   COUNT(CASE WHEN BR.STATUS = 'Y' THEN 1 END) > 0
 		 ORDER
    		BY 
       		   B.BOARD_NO DESC
	</select>
	
	<select id="selectBoard" resultType="AdminBoardDTO">
		<include refid="findAdminBoardDTO" />
		 WHERE
       		   B.BOARD_NO = #{boardNo}
 	    <include refid="groupByAdminBoardDTO" />
	</select>
	
	<select id="selectAttachemnt" resultType="AttachmentDTO">
		SELECT
       		   ATTACHMENT_PATH attachmentPath
  		  FROM
       		   TB_ATTACHMENT
 		 WHERE
       		   REF_BNO = #{boardNo}
	</select>
	
	<select id="countBoards" resultType="int">
        SELECT 
        	   COUNT(*)
          FROM 
               TB_BOARD
    </select>
    
    <select id="countReportedBoards" resultType="int">
		SELECT 
       		   COUNT(DISTINCT REF_BNO)
  		  FROM 
       		   TB_BOARD_REPORT
 		 WHERE 
       		   STATUS = 'Y'
	</select>	
	
	<update id="deleteBoard">
		UPDATE
       		   TB_BOARD
   		   SET
       		   STATUS = 'N'
 		 WHERE
       		   BOARD_NO = #{boardNo}
	</update>

	<update id="restoreBoard">
		UPDATE
		       TB_BOARD
		   SET
		       STATUS = 'Y'
		 WHERE
		       BOARD_NO = #{boardNo}
	</update>
	
	<select id="selectReport">
        SELECT 
        	   COUNT(*)
          FROM 
               TB_BOARD_REPORT
         WHERE
               REF_BNO = #{boardNo}
           AND
               STATUS = 'Y'		
	</select>
	
	<update id="handleReport">
		UPDATE 
       		   TB_BOARD_REPORT
   		   SET
       		   STATUS = 'N'
 		 WHERE
      		   REF_BNO = #{boardNo}
   		   AND
       		   STATUS = 'Y'
	</update>
	
	
	
	
</mapper>