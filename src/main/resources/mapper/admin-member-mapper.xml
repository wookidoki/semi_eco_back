<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.eco.admin.model.dao.AdminMemberMapper">

	<!-- 공통 SQL 조각 -->
	<sql id="updateMemberUpper">
		UPDATE TB_MEMBER SET
	</sql>

	<sql id="updateMemberLower">
		WHERE MEMBER_NO = #{memberNo}
	</sql>

	<!-- 아이디로 회원 정보 조회 -->
	<select id="findMemberById" resultType="AdminMemberDTO">
		SELECT
			MEMBER_NO memberNo,
			CASE WHEN LENGTH(MEMBER_NAME) >= 2
				THEN SUBSTR(MEMBER_NAME, 1, 1) || '*' || SUBSTR(MEMBER_NAME, 3)
				ELSE MEMBER_NAME
			END AS memberName,
			MEMBER_ID memberId,
			REGEXP_SUBSTR(PHONE, '^\d{2,3}')
				|| '-' || RPAD('*', LENGTH(REGEXP_SUBSTR(PHONE, '^\d{2,3}-(\d+)-', 1, 1, NULL, 1)), '*')
				|| '-' || REGEXP_SUBSTR(PHONE, '\d{4}$') AS phone,
			REGEXP_REPLACE(EMAIL,'(^..)(.*)(...@.*)','\1**\3') AS email,
			MEMBER_POINT memberPoint,
			REGION_NAME regionName,
			STATUS status,
			ROLE role
		FROM TB_MEMBER
		JOIN TB_REGION ON REF_RNO = REGION_NO
		WHERE MEMBER_ID = #{memberId}
	</select>

	<!-- 회원 번호로 회원 정보 조회 -->
	<select id="findByMemberNo" resultType="AdminMemberDTO">
		SELECT
			MEMBER_NO memberNo,
			MEMBER_NAME memberName,
			MEMBER_ID memberId,
			PHONE phone,
			EMAIL email,
			MEMBER_POINT memberPoint,
			REF_RNO refRno,
			STATUS status,
			ROLE role
		FROM TB_MEMBER
		WHERE MEMBER_NO = #{memberNo}
	</select>

	<!-- 지역명으로 지역 번호 조회 -->
	<select id="findRegionNoByName" resultType="java.lang.Integer">
		SELECT REGION_NO
		FROM TB_REGION
		WHERE REGION_NAME = #{regionName}
	</select>

	<!-- 아이디 변경 -->
	<update id="updateMemberIdByAdmin">
		<include refid="updateMemberUpper" />
		MEMBER_ID = #{newId}
		<include refid="updateMemberLower" />
	</update>

	<!-- 비밀번호 변경 -->
	<update id="updatePasswordByAdmin">
		<include refid="updateMemberUpper" />
		MEMBER_PWD = #{newPwd}
		<include refid="updateMemberLower"/>
	</update>

	<!-- 전화번호 변경 -->
	<update id="updatePhoneByAdmin">
		<include refid="updateMemberUpper" />
		PHONE = #{newPhone}
		<include refid="updateMemberLower"/>
	</update>

	<!-- 이메일 변경 -->
	<update id="updateEmailByAdmin">
		<include refid="updateMemberUpper" />
		EMAIL = #{newEmail}
		<include refid="updateMemberLower"/>
	</update>

	<!-- 지역 변경 -->
	<update id="updateRegionByAdmin">
		<include refid="updateMemberUpper" />
		REF_RNO = #{regionNo}
		<include refid="updateMemberLower"/>
	</update>

	<!-- 포인트 변경 -->
	<update id="updatePointByAdmin">
		<include refid="updateMemberUpper" />
		MEMBER_POINT = #{newPoint}
		<include refid="updateMemberLower"/>
	</update>

	<!-- 회원 상태 변경 -->
	<update id="updateStatusByAdmin">
		<include refid="updateMemberUpper" />
		STATUS = #{newStatus}
		<include refid="updateMemberLower"/>
	</update>

	<!-- 권한 변경 -->
	<update id="updateRoleByAdmin">
		<include refid="updateMemberUpper" />
		ROLE = #{newRole}
		<include refid="updateMemberLower"/>
	</update>

	<!-- 이름 변경 -->
	<update id="updateNameByAdmin">
		<include refid="updateMemberUpper" />
		MEMBER_NAME = #{newName}
		<include refid="updateMemberLower"/>
	</update>

</mapper>
